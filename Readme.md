## Описание проекта:
Приложение является серверным приложением для парсинга и систематизации ценных бумаг с биржи MOEX.

## Стек технологий:
- Frontend: HTML, CSS, JS
- Backend: Flask, PostgreSQL, SQLAlchemy,
- Управление зависимостями: pip

## Установка зависимостей - pip:
В качестве инструмента управления зависимостями используется втроенный пакетный менеджер pip.
Все зависимости проекта отражены в файле **requirements.txt**  

Для установки зависимостей выполните команду:  
`pip install -r requirements.txt` 
 
Все зависимости проекта будут установлены в ваше виртуальное окружение.

## Запуск проекта:
После установки всех зависимостей можно развернуть проект на локальной машине

### Развертывание на локальной машине:
После установки всех зависимостей проекта, необходимо запустить
программный сервер.

Проект развернется на [локалхосте](http://127.0.0.1:5000) и 
можно переходить к работе с эндпоинтами.

При первом запуске проекта, приложение начнет парсинг данных.

Проект можно развернуть на локальной машине запустив файл `main.py`

В проекте доступен графический интерфейс. Его подробное описание
ниже в пункте **"Frontend"**.  

## Frontend:
Для реализации frontend-части приложения используется
стек HTML, CSS, JS. Каждый компонент содержится в
соответствующей директории.  

- Templates  

Содержит HTML-страницы:
главной страницы с навигацией `index.html`,
страницы с отображением таблицы по ценным бумагам `security.html`,
страницы с отображением сводной таблицы `cross.html`

Основным инструментом на этих страницах является тег __Template__

- Static/styles  

Содержит описание css-стилей страниц и основных элементов на странице.

- Static/scripts 

Содержит index.js файл, основная задача которого отправлять fetch 
запросы на бэкенд с целью получения данных из бд, а также
клонирование и заполнение шаблона данными с сервера.

## Backend:
Основными компонентами Backend являются база данных `PostgreSQL` и 
и приложение на фреймворке `Flask`. Рассмотрим эти компоненты 
подробнее.  

### База данных и работа с миграциями - PostgreSQL:

Для корректной работы с базой данных необходимо установить
PostgreSQL с официального **[сайта](https://www.postgresql.org/download/)**.
Для работы с PostgreSQL через SQLAlchemy устанавливаем драйвер `psycopg`, он есть в файле зависимостей.
Также необходимо будет произвести настройку сервера PostgreSQL (можно через pgAdmin4). 
Настройки можно взять из файла .env.example и скопировать в файл .env

За корректную работу с базой данных, создание БД, 
подключение к ней отвечают 3 файла конфигурации БД:  
- Файл `config.py` отвечает за импорт переменных из 
переменных окружения. Импортируем имя хоста, номер порта, 
имя БД, имя пользователя и пароль.
- Файл `env.py` в корне проекта отвечает за
конфигурацию PostgreSQL, а также
описание переменных окружения.
- Файл `src/database/db_session.py` устанавливает 
соединение с созданной БД в PostgreSQL, создает переменную с метаданными.

### Работа с Flask:
Основная работа с фреймворком `Flask` происходит
в директории `src`. Файловая структура в этой директории
выглядит следующим образом:

```text
src                           # source root директория
│─── database                 # работа с бд
│     | db_session.py         # сессия работы с бд     
│
└─── models        	      # описание таблиц в бд для SQLAlchemy
│     | __all_models.py	      # импорт всех моделей	
│     | history.py            # модель с историей по ценной бумаге
│     | securities.py         # модель ценной бумаги
│    
└───  config.py               # получение переменных окружения
│              
└───  utils                                 # дополнительные утилиты проекта
│     | add_missing_security.py	            # делает доп. запрос для добавления данных по бумагам	
│     | from_json_to_history_db.py          # запись с json в таблицу history
│     | from_json_to_securities_db.py       # запись с json в таблицу securities
│     | history_json_preprocessing.py       # предобработка json с историями
│     | parse_history.py                    # парсинг данных по историям с мосбиржи
│     | parse_securities.py                 # парсинг данных по бумагам с мосбиржи
│     | securities_json_preprocessing.py    # предобработка json с ценными бумагами
│ 
└───  main.py                 # точка входа в приложение, содержит описание работы эндпоинтов
```
### Рассмотрим подробнее основные эндпоинты приложения `Flask` в `main.py`.
```python
# инициализируем приложение flask
app = Flask(__name__)
app.config['SECRET_KEY'] = KEY


# эндпоинт главной страницы, рендерим index.html
@app.route("/")
def index():
    return render_template("index.html")


# эндпоинт отображения таблицы securities, рендерим security.html
@app.route('/securities', methods=['GET', 'POST'])
def securities_page():
    return render_template("security.html")


# эндпоинт сводной таблицы, рендерим cross.html
@app.route('/cross', methods=['GET', 'POST'])
def cross_page():
    return render_template("cross.html")


# эндпоинт для fetch запроса от js за получением данных о бумагах
@app.route('/api/securities', methods=['GET', 'POST'])
def get_securities():
    db_sess = db_session.create_session()
    securities = db_sess.query(Securities).all()
    securities_to_json = dict()
    for i in range(len(securities)):
        securities_to_json[i] = {
            'id': securities[i].id,
            'secid': securities[i].secid,
            'regnumber': securities[i].regnumber,
            'name': securities[i].name,
            'emitent_title': securities[i].emitent_title,
        }
    db_sess.close()
    return jsonify(securities_to_json)


# эндпоинт для fetch запроса от js за получением данных для построения сводной таблицы
@app.route('/api/cross', methods=['GET', 'POST'])
def get_cross():
    db_sess = db_session.create_session()
    securities = db_sess.query(Securities).all()
    cross_to_json = dict()
    for i in range(len(securities)):
        history = db_sess.query(History).where(History.secid == str(securities[i].secid)).first()
        cross_to_json[i] = {
            'secid': securities[i].secid,
            'regnumber': securities[i].regnumber,
            'name': securities[i].name,
            'emitent_title': securities[i].emitent_title,
            'tradedate': history.tradedate if history else None,
            'numtrade': history.numtrades if history else None,
            'open': history.open if history else None,
            'close': history.close if history else None,
        }
    db_sess.close()
    return jsonify(cross_to_json)


# точка входа в приложение
def main():
    db_session.global_init()  # инициализируем подключение
    load_securities_to_db(BASE_SECURITIES_URL)  # если записей нет, то парсим, предобрабатываем и пишем данные в таблицу
    load_history_to_db(BASE_HISTORY_URL)  # А также дополняем таблицу с бумагами 
    app.run()


if __name__ == '__main__':
    main()
``` 



## Переменные окружения и файлы конфигурации:
Для корректной работы приложения в проекте присутствуют файлы
конфигурации и переменные окружения:  
- Файл `.env` для работы с переменными окружения при разработке
- Файл `config.py` для получения значений из переменных окружения


## Заметки (NOTES)!
При первом запуске приложения, сервер не запуститься мгновенно.
Сначала будет происходить парсинг, предобработка данных, а также дополнение таблицы с бумагами, по которым
есть история, но мы их не спарсили в таблицу с бумагами.

После парсинга запустится сервер и можно переходить к работе с эндпоинтами.


## Дальнейшие улучшения приложения
По причине небольшого количества выделенного времени, в приложении не реализован некоторый функционал, 
а также страдает реализация текущего.

1. Пункт 2. Реализован API для CRUD операции с основными таблицами, он лежит в директории api. 
Этот функционал реализован поверхностно, не содержит методов по поиску и обновлению записей по параметрам,
а также данный функционал не интегрирован в основное приложение.
2. Доп. пункт 2. Посчиталось, что функционал, который предлагается для MVP приложения, слишком обширный
для текущих временных границ. Однако был реализован частичный функционал с отображением таблиц, для 
демонстрации основных технологий: html - template, css - flex, js - поиск элементов, работа с запросами,
рендеринг шаблонов
3. Доп. пункт 3 реализован в утилите add_missing_security.py. При наличии большего количества времени,
было бы хорошо выполнять данную операцию в отдельном потоке.
